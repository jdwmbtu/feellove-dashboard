<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeelLove Coffee Dashboard</title>

    <!-- Firebase SDK (for notes persistence) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="manager-theme.css">
    <link rel="stylesheet" href="print.css">

    <!-- Legacy styles for finance tables -->
    <style>
        /* Keep existing table styles for finance sections */
        .data-table {
            margin: 10px auto;
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .data-table th { background: #e0e0e0; font-weight: bold; }
        .data-table tr:nth-child(even) { background-color: #f9f9f9; }
        .data-table tr:hover { background-color: #fffacd !important; }
        .negative { color: red; }

        /* Legacy Gantt styles */
        .gantt-header {
            display: grid;
            font-weight: bold;
            background: #34495e;
            color: white;
            padding: 10px 0;
            border-radius: 8px 8px 0 0;
        }
        .gantt-header > div { text-align: center; padding: 8px 4px; font-size: 0.9em; }
        .hour { position: relative; }
        .hour span { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); font-size: 0.85em; }
        .employee-row { display: grid; grid-template-columns: 150px 1fr; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid #eee; }
        .employee-name { font-weight: bold; padding-left: 12px; font-size: 0.9em; }
        .timeline { position: relative; height: 44px; background: #f8f9fa; border-radius: 6px; overflow: hidden; }
        .shift-bar { position: absolute; top: 4px; height: 36px; background: #3498db; border-radius: 6px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }

        #chart-container { margin: 20px auto; width: 90%; max-width: 800px; height: 400px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 10px; display: none; }
    </style>
</head>
<body>

<!-- PRINT HEADER (only shows when printing) -->
<div class="print-header print-only">
    <img src="https://feellovecoffee.com/wp-content/uploads/2024/09/FLC_Logo_Transp.svg" alt="FeelLove Coffee" class="print-logo">
    <div class="print-header-text">
        <div class="print-store-name" id="print-store-name">Cafe FeelLove</div>
        <div class="print-header-date" id="print-header-date"></div>
    </div>
</div>

<!-- HEADER -->
<header class="dashboard-header">
    <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 8px;">
        <img src="https://feellovecoffee.com/wp-content/uploads/2024/09/fl_logo.svg" alt="FeelLove Coffee" style="height: 60px;">
        <h1 style="margin: 0;">FeelLove Coffee</h1>
    </div>
    <div class="date-nav no-print" style="display: flex; align-items: center; gap: 12px; margin: 8px 0;">
        <button onclick="changeDay(-1)" style="padding: 8px 16px; font-size: 1.2rem; border: 2px solid #c9a227; border-radius: 8px; background: white; cursor: pointer;">&larr;</button>
        <div class="date" id="current-date" style="font-size: 1.1rem; font-weight: 600; min-width: 200px; text-align: center;">Loading...</div>
        <button onclick="changeDay(1)" style="padding: 8px 16px; font-size: 1.2rem; border: 2px solid #c9a227; border-radius: 8px; background: white; cursor: pointer;">&rarr;</button>
        <button onclick="goToToday()" style="padding: 8px 12px; font-size: 0.9rem; border: 2px solid #3498db; border-radius: 8px; background: #3498db; color: white; cursor: pointer;">Today</button>
    </div>
    <div class="date print-only" id="print-date" style="font-size: 1.1rem;"></div>
    <div class="store-selector no-print" style="display: flex; align-items: center; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <select id="store-filter" onchange="updateTables()">
            <option value="CAFE">Cafe FeelLove</option>
            <option value="FEELLOVE">Riverside</option>
            <option value="SNOW">Snow Canyon</option>
            <option value="ZION">Zion Springdale</option>
        </select>
        <button id="btn-update-schedule" onclick="updateSchedule()" style="padding: 8px 12px; font-size: 0.85rem; border: 2px solid #27ae60; border-radius: 8px; background: white; color: #27ae60; cursor: pointer; font-weight: 500;">
            â†» Schedule
        </button>
        <button id="btn-update-sales" onclick="updateSales()" style="padding: 8px 12px; font-size: 0.85rem; border: 2px solid #3498db; border-radius: 8px; background: white; color: #3498db; cursor: pointer; font-weight: 500;">
            â†» Sales
        </button>
    </div>
    <div class="store-selector print-only">
        <select id="store-filter-print" disabled>
            <option value="CAFE">Cafe FeelLove</option>
            <option value="FEELLOVE">Riverside</option>
            <option value="SNOW">Snow Canyon</option>
            <option value="ZION">Zion Springdale</option>
        </select>
    </div>
    <div id="sync-status" class="no-print" style="margin-top: 8px; font-size: 0.85rem; color: #7f8c8d; min-height: 18px; text-align: center;"></div>
    <div class="no-print" style="margin-top: 8px;">
        <button onclick="printDashboard()" style="padding: 8px 20px; font-size: 0.9rem; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
            ðŸ–¨ Print Dashboard
        </button>
    </div>
</header>

<!-- PROGRESS SECTION -->
<section class="progress-section">
    <!-- Goal Selector -->
    <div class="goal-control no-print" style="margin-bottom: 20px;">
        <label style="font-size: 0.9rem; color: #7f8c8d; margin-right: 8px;">Monthly Target:</label>
        <select id="goal-selector" onchange="updateGoalFromSelector()" style="padding: 10px 16px; font-size: 1rem; border: 2px solid #c9a227; border-radius: 8px; background: white; cursor: pointer;">
            <optgroup label="Growth %">
                <option value="pct_10">+10% over last year</option>
                <option value="pct_15">+15% over last year</option>
                <option value="pct_20" selected>+20% over last year</option>
                <option value="pct_25">+25% over last year</option>
                <option value="pct_30">+30% over last year</option>
            </optgroup>
            <optgroup label="Fixed Amount">
                <option value="add_5000">+$5K over last year</option>
                <option value="add_10000">+$10K over last year</option>
                <option value="add_15000">+$15K over last year</option>
                <option value="add_20000">+$20K over last year</option>
                <option value="add_25000">+$25K over last year</option>
            </optgroup>
            <optgroup label="Custom">
                <option value="custom">Set custom goal...</option>
            </optgroup>
        </select>
        <input type="number" id="custom-goal-input"
               style="display: none; width: 120px; margin-left: 8px; padding: 10px; font-size: 1rem; border: 2px solid #c9a227; border-radius: 8px;"
               placeholder="$0" step="1000" min="0"
               onchange="saveCustomGoal(this.value)">
    </div>

    <!-- Main Progress Display -->
    <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; margin-bottom: 24px;">
        <!-- Big Percentage -->
        <div style="text-align: center; min-width: 150px;">
            <div class="progress-percentage" id="progress-percentage" style="font-size: 3.5rem; font-weight: 700; color: #2c3e50;">--%</div>
            <div style="font-size: 0.9rem; color: #7f8c8d;">of monthly goal</div>
        </div>

        <!-- Current / Goal (inline) -->
        <div style="text-align: center; min-width: 200px;">
            <div style="font-size: 1.8rem; font-weight: 700;">
                <span id="progress-current" style="color: #27ae60;">$0</span>
                <span style="color: #7f8c8d; font-weight: 400;"> / </span>
                <span id="progress-goal" style="color: #c9a227;">$0</span>
            </div>
            <div style="font-size: 0.85rem; color: #7f8c8d;">MTD Sales / Monthly Goal</div>
        </div>
    </div>

    <!-- Progress Bar with Pace Marker -->
    <div class="progress-bar-container" style="margin-bottom: 24px;">
        <div style="background: #e8e8e8; border-radius: 12px; height: 32px; overflow: visible; position: relative;">
            <div id="progress-bar-fill" style="background: linear-gradient(90deg, #27ae60, #2ecc71); height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 12px;"></div>
            <!-- Pace marker (where you should be) -->
            <div id="progress-pace-marker" style="position: absolute; top: -6px; bottom: -6px; width: 4px; background: #c9a227; border-radius: 2px; box-shadow: 0 0 4px rgba(0,0,0,0.3);" title="Target pace"></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.8rem; color: #7f8c8d;">
            <span>$0</span>
            <span id="progress-pace-label" style="color: #c9a227; font-weight: 600;">On pace for $0</span>
            <span id="progress-bar-target">$0</span>
        </div>
    </div>

    <!-- TODAY'S TARGETS - Big and Clear -->
    <div style="background: linear-gradient(135deg, #2c3e50, #34495e); border-radius: 16px; padding: 24px; margin-bottom: 20px; color: white;">
        <div style="text-align: center; margin-bottom: 16px; font-size: 1.1rem; opacity: 0.9;">Today's Targets</div>
        <div class="daily-targets" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
            <!-- Daily Sales Target -->
            <div>
                <div id="daily-sales-target" style="font-size: 2rem; font-weight: 700;">$0</div>
                <div style="font-size: 0.85rem; opacity: 0.8;">Sales Goal</div>
            </div>
            <!-- Daily Orders Target -->
            <div>
                <div id="daily-orders-target" style="font-size: 2rem; font-weight: 700;">0</div>
                <div style="font-size: 0.85rem; opacity: 0.8;">Orders Goal</div>
            </div>
            <!-- Daily AOV Target -->
            <div>
                <div id="daily-aov-target" style="font-size: 2rem; font-weight: 700;">$0</div>
                <div style="font-size: 0.85rem; opacity: 0.8;">AOV Goal</div>
            </div>
        </div>
    </div>

    <!-- Secondary Info Row -->
    <div class="target-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
        <!-- Month Progress -->
        <div class="target-card" style="background: #fff; border: 2px solid #3498db; border-radius: 12px; padding: 16px; text-align: center;">
            <div id="target-remaining" style="font-size: 1.3rem; font-weight: 700; color: #3498db;">$0</div>
            <div style="font-size: 0.8rem; color: #7f8c8d;">Left This Month</div>
        </div>
        <!-- Days Left -->
        <div class="target-card" style="background: #fff; border: 2px solid #9b59b6; border-radius: 12px; padding: 16px; text-align: center;">
            <div id="target-days-left" style="font-size: 1.3rem; font-weight: 700; color: #9b59b6;">0</div>
            <div style="font-size: 0.8rem; color: #7f8c8d;">Days Left</div>
        </div>
        <!-- Pace Status -->
        <div id="pace-status-card" class="target-card" style="background: #fff; border: 2px solid #27ae60; border-radius: 12px; padding: 16px; text-align: center;">
            <div id="pace-status" style="font-size: 1.1rem; font-weight: 700; color: #27ae60;">On Track</div>
            <div id="pace-status-detail" style="font-size: 0.8rem; color: #7f8c8d;">vs. pace</div>
        </div>
        <!-- vs Last Year -->
        <div class="target-card" style="background: #fff; border: 2px solid #7f8c8d; border-radius: 12px; padding: 16px; text-align: center;">
            <div id="yoy-change" style="font-size: 1.1rem; font-weight: 700; color: #7f8c8d;">--%</div>
            <div style="font-size: 0.8rem; color: #7f8c8d;">vs. Last Year</div>
        </div>
    </div>

    <!-- Hidden elements for compatibility -->
    <div style="display:none;">
        <span id="target-daily">$0</span>
        <span id="forecast-projected">$0</span>
        <span id="forecast-vs-goal"></span>
        <span id="last-year-mtd">$0</span>
        <span id="aov-target">$0</span>
        <span id="aov-current"></span>
    </div>

    <!-- Motivational Message -->
    <div class="motivational-message" id="motivational-message" style="text-align: center; font-size: 1.1rem; padding: 12px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #27ae60;">Loading...</div>

    <!-- Print-friendly version -->
    <div class="progress-print-summary print-only">
        <div class="progress-amounts" id="progress-amounts-print">$0 / $0</div>
    </div>
</section>

<!-- 7-DAY TREND CHART (screen) -->
<section class="chart-section" style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <h2 class="section-title" style="margin-top: 0;">Last 7 Days</h2>
    <div style="position: relative; height: 200px;">
        <canvas id="seven-day-chart"></canvas>
    </div>
    <div id="seven-day-summary" style="display: flex; justify-content: space-around; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e0e0; text-align: center;">
        <div>
            <div id="seven-day-total" style="font-size: 1.25rem; font-weight: 700; color: #2c3e50;">$0</div>
            <div style="font-size: 0.8rem; color: #7f8c8d;">7-Day Total</div>
        </div>
        <div>
            <div id="seven-day-avg" style="font-size: 1.25rem; font-weight: 700; color: #3498db;">$0</div>
            <div style="font-size: 0.8rem; color: #7f8c8d;">Daily Avg</div>
        </div>
        <div>
            <div id="seven-day-best" style="font-size: 1.25rem; font-weight: 700; color: #27ae60;">$0</div>
            <div style="font-size: 0.8rem; color: #7f8c8d;">Best Day</div>
        </div>
    </div>
</section>

<!-- 7-DAY CHART (print-only, HTML-based) -->
<div class="print-chart print-only" id="print-chart">
    <div class="print-chart-title">Last 7 Days</div>
    <div class="print-chart-bars" id="print-chart-bars">
        <!-- Populated by JavaScript -->
    </div>
</div>

<!-- Hidden stats for compatibility -->
<div style="display: none;">
    <span id="stat-orders">--</span>
    <span id="stat-aov">$--</span>
    <span id="stat-staff-hours">--h</span>
</div>

<!-- TEAM AND NOTES WRAPPER (side by side in print) -->
<div class="print-two-column">
    <!-- TEAM SCHEDULE WITH NOTES -->
    <section class="team-section">
        <h2 class="section-title">Today's Team</h2>
        <div id="schedule-date-display" style="text-align: center; color: #7f8c8d; margin-bottom: 16px;"></div>
        <div id="team-list" class="staff-list">
            <div class="loading">Loading schedule...</div>
        </div>
        <div class="staff-totals" id="staff-totals" style="display: none;">
            <span>Total Staff Hours:</span>
            <span id="total-staff-hours">0h</span>
        </div>
    </section>

    <!-- DAY NOTES -->
    <section class="day-notes-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h2 class="section-title" style="margin-bottom: 0;">Daily Notes</h2>
            <button id="btn-copy-day-note" class="no-print" onclick="copyDayNoteFromPrevious()"
                    style="padding: 4px 10px; font-size: 0.8rem; background: #f8f8f8; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; color: #666;">
                â†© Previous
            </button>
        </div>
        <textarea id="day-note-input" class="day-note-input"
                  placeholder="Add notes for the day (reminders, focus areas, special events...)"></textarea>
        <div class="note-status" id="day-note-status"></div>
    </section>
</div>

<!-- FINANCE DETAILS (Collapsed by default) -->
<section class="finance-section no-print">
    <button class="finance-toggle" id="finance-toggle" onclick="toggleFinance()">
        Show Detailed Metrics
    </button>
    <div class="finance-content" id="finance-content">

        <!-- Hidden Controls -->
        <div id="controls-container" style="max-width: 500px; margin: 20px auto; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <table class="data-table" style="font-size: 0.9em;">
                <tr><td><label for="month-filter">Month:</label></td><td><select id="month-filter" onchange="updateTables()"></select></td></tr>
                <tr><td><label for="growth-target">Growth Target:</label></td><td>
                    <select id="growth-target" onchange="updateGrowthTarget()">
                        <optgroup label="Percent">
                            <option value="10">+10%</option><option value="20">+20%</option><option value="25">+25%</option><option value="30">+30%</option>
                        </optgroup>
                        <optgroup label="Dollar ($K)">
                            <option value="5">+$5K</option><option value="10">+$10K</option><option value="15">+$15K</option><option value="20" selected>+$20K</option><option value="25">+$25K</option>
                        </optgroup>
                    </select>
                </td></tr>
                <tr><td><label>Adjusted:</label></td><td><label><input type="checkbox" id="adjusted-toggle" onchange="updateTables()"> Yes</label></td></tr>
            </table>
        </div>

        <!-- Summary Table -->
        <div style="max-width: 600px; margin: 20px auto;">
            <h3>Summary</h3>
            <table id="summary-table" class="data-table" style="font-size: 0.9em;">
                <thead>
                    <tr>
                        <th style="width: 40%;">Metric</th>
                        <th style="width: 60%;">Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 7-Day Prediction -->
        <div style="max-width: 600px; margin: 20px auto;">
            <h3>Next 7 Days</h3>
            <div id="seven-day-prediction-container">
                <table class="data-table" style="font-size:0.9em;">
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Daily Metrics -->
        <div style="max-width: 1200px; margin: 20px auto;">
            <h3 id="metrics-h2">Daily Metrics</h3>
            <div id="metrics-sub-headers"></div>
            <table id="metrics-table" class="data-table">
                <thead>
                    <tr>
                        <th rowspan="2">Day</th>
                        <th id="sales-header" colspan="4">Sales</th>
                        <th id="orders-header" colspan="4">Orders</th>
                        <th id="aov-header" colspan="4">AOV</th>
                    </tr>
                    <tr>
                        <th>2024</th><th>2025</th><th>$</th><th>%</th>
                        <th>2024</th><th>2025</th><th>#</th><th>%</th>
                        <th>2024</th><th>2025</th><th>$</th><th>%</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Day Counts -->
        <div style="max-width: 800px; margin: 20px auto;">
            <h3 id="daycount-h2">Day Counts</h3>
            <table id="daycount-table" class="data-table">
                <thead><tr><th>Category</th><th>2024 Count</th><th>2025 Elapsed</th><th>2025 Remaining</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Forecast + Scenarios -->
        <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1000px; margin: 20px auto;">
            <div style="flex: 1; min-width: 300px;">
                <h3 id="forecast-h2">Forecast</h3>
                <table id="forecast-table" class="data-table" style="font-size: 0.9em;">
                    <thead><tr><th>Category</th><th>MTD</th><th>ROM</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <h3 id="scenarios-h2">Scenarios</h3>
                <table id="scenarios-table" class="data-table" style="font-size: 0.9em;">
                    <thead><tr><th>MTD</th><th>Scenario</th><th>ROM</th><th>Total</th><th>vs Target</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Hidden elements for legacy compatibility -->
<div id="chart-container"></div>
<span id="schedule-date" style="display:none;"></span>
<div id="schedule-container" style="display:none;">
    <div id="gantt-chart"></div>
</div>

<!-- Scripts -->
<script src="firebase-config.js"></script>
<script src="notes.js"></script>
<script src="script.js"></script>
<script>
// Finance section toggle
function toggleFinance() {
    const content = document.getElementById('finance-content');
    const toggle = document.getElementById('finance-toggle');
    content.classList.toggle('show');
    toggle.classList.toggle('expanded');
    toggle.textContent = content.classList.contains('show') ? 'Hide Detailed Metrics' : 'Show Detailed Metrics';
}

// Day navigation
let selectedDate = new Date();

// Read initial state from URL params
function initFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const storeParam = params.get('store');
    const dateParam = params.get('date');

    if (storeParam) {
        const storeFilter = document.getElementById('store-filter');
        if (storeFilter && storeFilter.querySelector(`option[value="${storeParam}"]`)) {
            storeFilter.value = storeParam;
        }
    }

    if (dateParam && /^\d{4}-\d{2}-\d{2}$/.test(dateParam)) {
        const [year, month, day] = dateParam.split('-').map(Number);
        selectedDate = new Date(year, month - 1, day);
    }
}

// Update URL without reload
function updateUrl() {
    const store = document.getElementById('store-filter').value;
    const year = selectedDate.getFullYear();
    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
    const day = String(selectedDate.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;

    const newUrl = `${window.location.pathname}?store=${store}&date=${dateStr}`;
    history.replaceState(null, '', newUrl);
}

function updateDateDisplay() {
    const dateStr = selectedDate.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric',
        timeZone: 'America/Denver'
    });
    document.getElementById('current-date').textContent = dateStr;
    document.getElementById('print-date').textContent = dateStr;
}

function changeDay(delta) {
    selectedDate.setDate(selectedDate.getDate() + delta);
    updateDateDisplay();
    updateUrl();
    loadDataForSelectedDate();
    if (typeof updatePrintHeader === 'function') updatePrintHeader();
}

function goToToday() {
    selectedDate = new Date();
    updateDateDisplay();
    updateUrl();
    loadDataForSelectedDate();
    if (typeof updatePrintHeader === 'function') updatePrintHeader();
}

function loadDataForSelectedDate() {
    const store = document.getElementById('store-filter').value;
    const year = selectedDate.getFullYear();
    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
    const day = String(selectedDate.getDate()).padStart(2, '0');
    const dateKey = `${year}-${month}-${day}`;

    // Set month filter to match selected date
    const monthFilter = document.getElementById('month-filter');
    if (monthFilter) {
        const selectedMonth = selectedDate.toLocaleString('en-US', { month: 'long' });
        if (monthFilter.querySelector(`option[value="${selectedMonth}"]`)) {
            monthFilter.value = selectedMonth;
        }
    }

    // Load schedule for selected date
    loadScheduleForDate(store, selectedDate);

    // Load day notes for selected date
    if (typeof loadDayNote === 'function') {
        loadDayNote(store, dateKey);
    }

    // Update progress ring for selected date (shows data as of going into that day)
    if (typeof updateProgressRingForDate === 'function') {
        updateProgressRingForDate(store, selectedDate);
    }

    // Update 7-day chart ending at day before selected date
    if (typeof updateSevenDayChartForDate === 'function') {
        updateSevenDayChartForDate(store, selectedDate);
    }
}

// =====================================================
// SYNC FUNCTIONS
// =====================================================
const SYNC_SERVER = 'http://localhost:3001';

function setSyncStatus(message, type = 'info') {
    const statusEl = document.getElementById('sync-status');
    if (!statusEl) return;

    const colors = {
        info: '#7f8c8d',
        success: '#27ae60',
        error: '#e74c3c',
        loading: '#f39c12'
    };

    statusEl.textContent = message;
    statusEl.style.color = colors[type] || colors.info;
}

function setButtonLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    if (!btn) return;

    if (loading) {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'wait';
    } else {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
    }
}

const WHENIWORK_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsIb6k6eJiC8rWiYdyjuWMxPXJtsQYydxulpCawFz_4l4Y9zXV6AE7zJv9ukK368AIdg/exec';

// Vercel serverless function for Square sales sync
const VERCEL_SYNC_URL = 'https://feellove-sync.vercel.app/api/sync-sales';

async function updateSchedule() {
    const store = document.getElementById('store-filter').value;
    setButtonLoading('btn-update-schedule', true);
    setSyncStatus(`Syncing ${store} schedule from WhenIWork...`, 'loading');

    try {
        // Call the Google Apps Script to sync from WhenIWork
        const response = await fetch(`${WHENIWORK_SCRIPT_URL}?store=${store}`, {
            method: 'GET',
            mode: 'cors'
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                setSyncStatus(`WhenIWork sync complete. Refreshing...`, 'info');
            } else {
                console.warn('WhenIWork sync warning:', result.message);
            }
        }

        // Wait a moment for the sheet to update
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Refresh the sheets data (this re-fetches from Google Sheets)
        if (typeof loadSheetsData === 'function') {
            await loadSheetsData();
        }

        // Reload the schedule for the current date
        if (typeof loadScheduleForDate === 'function') {
            await loadScheduleForDate(store, selectedDate);
        }

        setSyncStatus(`${store} schedule updated!`, 'success');

        // Clear status after 3 seconds
        setTimeout(() => setSyncStatus(''), 3000);
    } catch (error) {
        console.error('Schedule update error:', error);
        setSyncStatus(`Error: ${error.message}`, 'error');
    } finally {
        setButtonLoading('btn-update-schedule', false);
    }
}

async function updateSales() {
    const store = document.getElementById('store-filter').value;
    setButtonLoading('btn-update-sales', true);

    // Sync the day BEFORE the selected date (in local timezone)
    const syncDate = new Date(selectedDate.getTime());
    syncDate.setDate(syncDate.getDate() - 1);
    const year = syncDate.getFullYear();
    const month = String(syncDate.getMonth() + 1).padStart(2, '0');
    const day = String(syncDate.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`; // YYYY-MM-DD in local time

    setSyncStatus(`Syncing ${store} sales for ${syncDate.toLocaleDateString()}...`, 'loading');

    try {
        // Call the Vercel serverless function to sync from Square
        const response = await fetch(`${VERCEL_SYNC_URL}?store=${store}&date=${dateStr}`, {
            method: 'GET',
            mode: 'cors'
        });

        const result = await response.json();
        if (response.ok && result.success) {
            const salesInfo = result.data?.[dateStr]?.[store];
            const msg = salesInfo
                ? `$${salesInfo.sales} sales, ${salesInfo.orders} orders`
                : `${result.ordersFound} orders processed`;
            setSyncStatus(`Square sync complete: ${msg}`, 'info');
        } else {
            console.warn('Square sync warning:', result.error || result.message);
            setSyncStatus(`Warning: ${result.error || result.message}`, 'error');
        }

        // Wait a moment for the sheet to update
        await new Promise(resolve => setTimeout(resolve, 1500));

        // Refresh the sheets data
        if (typeof loadSheetsData === 'function') {
            await loadSheetsData();
        }

        // Update the current view
        if (typeof updateTables === 'function') {
            updateTables();
        }

        setSyncStatus(`${store} sales data synced!`, 'success');

        // Clear status after 3 seconds
        setTimeout(() => setSyncStatus(''), 3000);
    } catch (error) {
        console.error('Sales sync error:', error);
        setSyncStatus(`Error: ${error.message}`, 'error');
    } finally {
        setButtonLoading('btn-update-sales', false);
    }
}

// Copy day note from last day that had one (searches up to 14 days back)
async function copyDayNoteFromPrevious() {
    const store = document.getElementById('store-filter').value;
    const btn = document.getElementById('btn-copy-day-note');
    if (btn) btn.textContent = '...';

    for (let i = 1; i <= 14; i++) {
        const prevDate = new Date(selectedDate);
        prevDate.setDate(prevDate.getDate() - i);
        const dateKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}-${String(prevDate.getDate()).padStart(2, '0')}`;

        const notes = await NotesManager.loadNotes(store, dateKey);
        if (notes.dayNote) {
            const textarea = document.getElementById('day-note-input');
            textarea.value = notes.dayNote;
            textarea.dispatchEvent(new Event('blur'));
            if (btn) btn.textContent = 'â†© Previous';
            return;
        }
    }

    if (btn) btn.textContent = 'â†© Previous';
    alert('No previous day note found (checked last 14 days)');
}

// Copy staff note from last day that employee had a note (searches up to 14 days back)
async function copyStaffNoteFromPrevious(employee) {
    const store = document.getElementById('store-filter').value;
    const sanitizedId = employee.replace(/[^a-zA-Z0-9]/g, '_');
    const btn = document.getElementById(`copy-btn-${sanitizedId}`);
    if (btn) btn.textContent = '...';

    for (let i = 1; i <= 14; i++) {
        const prevDate = new Date(selectedDate);
        prevDate.setDate(prevDate.getDate() - i);
        const dateKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}-${String(prevDate.getDate()).padStart(2, '0')}`;

        const notes = await NotesManager.loadNotes(store, dateKey);
        const staffNote = notes.staff?.[employee]?.note;

        if (staffNote) {
            const textarea = document.getElementById(`note-${sanitizedId}`);
            if (textarea) {
                textarea.value = staffNote;
                textarea.dispatchEvent(new Event('blur'));
            }
            if (btn) btn.textContent = 'â†©';
            return;
        }
    }

    if (btn) btn.textContent = 'â†©';
    alert(`No previous note found for ${employee} (checked last 14 days)`);
}

// Initialize from URL params, then update display
initFromUrl();
updateDateDisplay();
updateUrl();

// Store display names for print header
const storeDisplayNames = {
    'CAFE': 'Cafe FeelLove',
    'FEELLOVE': 'Riverside',
    'SNOW': 'Snow Canyon',
    'ZION': 'Zion Springdale'
};

function updatePrintHeader() {
    const store = document.getElementById('store-filter').value;
    const printStoreName = document.getElementById('print-store-name');
    const printHeaderDate = document.getElementById('print-header-date');

    if (printStoreName) {
        printStoreName.textContent = storeDisplayNames[store] || store;
    }
    if (printHeaderDate) {
        printHeaderDate.textContent = selectedDate.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric',
            timeZone: 'America/Denver'
        });
    }
}

// Handle store filter changes
document.getElementById('store-filter').addEventListener('change', function() {
    updateUrl();
    updatePrintHeader();
});

// Initial print header update
updatePrintHeader();
</script>
</body>
</html>
